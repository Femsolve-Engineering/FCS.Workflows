name: Publish Docker Image to Fly.io (no prereqs)

on:
  workflow_call:
    inputs:
      releaseVersion:
        required: true
        type: string
      flyAppName:
        required: true
        type: string
      dockerContext:
        required: false
        type: string
        default: .
      dockerfile:
        required: false
        type: string
        default: Dockerfile

jobs:
  build-and-push-image-to-flyio:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Log in to Fly.io Registry
      # fly registry auth is via the Fly API token
        run: |
          echo "${{ secrets.INHERITED_FLY_API_TOKEN }}" | docker login registry.fly.io -u x --password-stdin

      - name: Build and Push Docker Image to Fly.io
        run: |
          echo "Building Docker image with tag ${{ inputs.releaseVersion }}"
          docker build \
            -f "${{ inputs.dockerfile }}" \
            -t "registry.fly.io/${{ inputs.flyAppName }}:${{ inputs.releaseVersion }}" \
            "${{ inputs.dockerContext }}"

          echo "Listing Docker images to verify build"
          docker images

          echo "Pushing Docker image with tag ${{ inputs.releaseVersion }}"
          docker push "registry.fly.io/${{ inputs.flyAppName }}:${{ inputs.releaseVersion }}"

          echo "Tagging Docker image as latest"
          docker tag \
            "registry.fly.io/${{ inputs.flyAppName }}:${{ inputs.releaseVersion }}" \
            "registry.fly.io/${{ inputs.flyAppName }}:latest"

          echo "Pushing Docker image with tag latest"
          docker push "registry.fly.io/${{ inputs.flyAppName }}:latest"
